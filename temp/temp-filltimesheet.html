<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fill Timesheet</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/timesheet/filltimesheet.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      function updateCategories() {
        const allocationType = document.getElementById("allocationType").value;
        const category1 = document.getElementById("category1");
        const category2 = document.getElementById("category2");
        const category3 = document.getElementById("category3");

        category1.innerHTML = '<option value="">Select Category 1</option>';
        category2.innerHTML = '<option value="">Select Category 2</option>';
        category3.innerHTML = '<option value="">Select Category 3</option>';

        if (allocationType === "billable") {
          const billableOptions = [
            "Pricing",
            "Capital",
            "Analytics",
            "Reserving",
            "CIO-UK",
            "HR",
          ];
          billableOptions.forEach((option) =>
            category1.options.add(new Option(option, option))
          );
        } else if (allocationType === "non-billable") {
          category1.options.add(new Option("Admin", "Admin"));
          category1.options.add(new Option("Training", "Training"));
        }
      }

      function updateCategory2() {
        const category1Value = document.getElementById("category1").value;
        const allocationType = document.getElementById("allocationType").value;
        const category2 = document.getElementById("category2");
        category2.innerHTML = '<option value="">Select Category 2</option>';
        document.getElementById("category3").innerHTML =
          '<option value="">Select Category 3</option>';

        if (allocationType === "billable") {
          fetch(`/timesheet/get_projects?category1=${category1Value}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to fetch projects");
              }
              return response.json();
            })
            .then((data) => {
              data.forEach((project) => {
                category2.options.add(
                  new Option(project.ProjectName, project.ProjectCode)
                );
              });
            })
            .catch((error) => {
              console.error(error);
              alert("Could not load projects. Please try again.");
            });
        } else if (allocationType === "non-billable") {
          if (category1Value === "Admin") {
            ["A1", "A2", "A3"].forEach((option) =>
              category2.options.add(new Option(option, option))
            );
          } else if (category1Value === "Training") {
            ["T1", "T2", "T3", "T4"].forEach((option) =>
              category2.options.add(new Option(option, option))
            );
          }
        }
      }

      function updateCategory3() {
        const category2Value = document.getElementById("category2").value;
        const category3 = document.getElementById("category3");
        category3.innerHTML = '<option value="">Select Category 3</option>';

        const category3Mapping = {
          T1: ["T1.1", "T1.2", "T1.3"],
          A2: ["A2.1", "A2.2", "A2.3"],
          A1: ["A101", "A102", "A103"],
        };

        if (category3Mapping[category2Value]) {
          category3Mapping[category2Value].forEach((option) =>
            category3.options.add(new Option(option, option))
          );
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("allocationType")
          .addEventListener("change", updateCategories);
        document
          .getElementById("category1")
          .addEventListener("change", updateCategory2);
        document
          .getElementById("category2")
          .addEventListener("change", updateCategory3);
      });

      flatpickr("#dateofentry", {
        mode: "multiple",
        dateFormat: "Y-m-d",
        maxDate: "today",
        allowInput: true,
        altInput: true,
        onChange: function (selectedDates, dateStr, instance) {
          const dateDurations = document.getElementById("dateDurations");
          dateDurations.innerHTML = "";
          selectedDates.forEach((date) => {
            const dateFormatted = instance.formatDate(date, "Y-m-d");
            const row = document.createElement("div");
            row.classList.add("ts-form-row", "ts-row-2");
            row.innerHTML = `
              <label>${dateFormatted} - Hours: </label>
              <select name="hours_${dateFormatted}">
                ${[...Array(9).keys()]
                  .map((hour) => `<option value="${hour}">${hour}</option>`)
                  .join("")}
              </select>
              <label>Minutes: </label>
              <select name="minutes_${dateFormatted}">
                ${[0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55]
                  .map(
                    (minute) => `<option value="${minute}">${minute}</option>`
                  )
                  .join("")}
              </select>
            `;
            dateDurations.appendChild(row);
          });
        },
      });
    </script>
  </head>
  <body>
    <div>{% include 'navbar/navbar.html' %}</div>
    <nav class="ts-nav-container">
      <div class="ts-nav-center">
        <a href="/timesheet" class="ts-nav-link">Timesheet</a>
        <a href="/timesheet/summary" class="ts-nav-link">View Summary</a>
      </div>
    </nav>
    <div class="ts-body">
      <div class="ts-form-body">
        <h2>Fill Timesheet</h2>
        <form
          class="ts-form"
          name="timesheetForm"
          method="POST"
          action="{{ url_for('timesheet.submit_timesheet') }}"
          onsubmit="return validateForm()"
        >
          <div class="ts-form-row ts-row-1">
            <label>EName: </label>
            <input type="text" name="EName" value="{{ user.EName }}" readonly />
            <label>LineManager: </label>
            <input
              type="text"
              name="LineManager"
              value="{{ user.LineManager }}"
              readonly
            />
            <label>EmpID: </label>
            <input type="text" name="EmpID" value="{{ user.EMPID }}" readonly />
            <label>Team: </label>
            <input type="text" name="Team" value="{{ user.Team }}" readonly />
          </div>

          <div class="ts-form-row ts-row-2">
            <label>Date of Entry: </label>
            <input
              type="text"
              id="dateofentry"
              name="DateofEntry"
              multiple
              placeholder="Select Date"
            />
          </div>

          <div id="dateDurations"></div>

          <div class="ts-form-row ts-row-3">
            <label>Project Code: </label>
            <select name="ProjectCode" id="projectCode">
              <option value="">Select Project Code</option>
            </select>
            <label>Allocation Type: </label>
            <select id="allocationType" name="AllocationType">
              <option value="">Select</option>
              <option value="billable">Billable</option>
              <option value="non-billable">Non-Billable</option>
            </select>
          </div>

          <div class="ts-form-row ts-row-4">
            <label>Category 1: </label>
            <select id="category1" name="Category1">
              <option value="">Select Category 1</option>
            </select>
            <label>Category 2: </label>
            <select id="category2" name="Category2">
              <option value="">Select Category 2</option>
            </select>
            <label>Category 3: </label>
            <select id="category3" name="Category3">
              <option value="">Select Category 3</option>
            </select>
          </div>

          <div class="ts-form-row ts-row-5">
            <label>Comments: </label>
            <textarea
              name="comments"
              class="ts-form-comments"
              placeholder="Write comments up to 200 chars..."
              maxlength="200"
            ></textarea>
          </div>

          <button type="submit">Submit Timesheet</button>
        </form>
      </div>
    </div>
  </body>
</html>
